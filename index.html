<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CurrentAffairs Editor — HI+EN → DOCX (Final)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
:root{--accent:#0b7a3e;--muted:#666;--card:#fff;--border:#e5e7eb}
body{font-family:Arial,Helvetica,sans-serif;margin:14px;background:#f6f7fb;color:#111}
.container{max-width:1100px;margin:auto}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
.header h1{font-size:18px;margin:0}
.muted{color:var(--muted)}
.wrap{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px}
.col{flex:1;min-width:320px;background:var(--card);border:1px solid var(--border);padding:12px;border-radius:8px;box-sizing:border-box}
label{display:block;font-weight:600;margin-top:8px}
input,textarea,select,button{font-size:14px}
input, textarea, select { width:100%; padding:8px; margin:6px 0; box-sizing:border-box; border:1px solid #d0d7de;border-radius:6px}
textarea{min-height:90px;resize:vertical}
.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;border:0;cursor:pointer}
.btn-green{background:var(--accent);color:#fff}
.btn-blue{background:#0d6efd;color:#fff}
.btn-muted{background:#666;color:#fff}
.icon-btn{background:transparent;border:0;font-size:16px;cursor:pointer;color:#000} /* icons black */
.card{border:1px solid #e8eaef;padding:10px;border-radius:8px;margin-bottom:10px;background:#fff}
.card-header{display:flex;justify-content:space-between;align-items:center}
.card-title{font-weight:700}
.card-meta{font-size:12px;color:var(--muted)}
.img-preview{max-width:220px;border-radius:6px;margin-top:8px;border:1px solid #ddd}
.preview-body{white-space:pre-wrap;margin-top:8px}
.small{font-size:13px;padding:6px 8px}
.rawBox{display:none} /* no raw preview */
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>CurrentAffairs Editor — HI + EN → DOCX (Final)</h1>
    <div class="muted">Autosaved locally · Translate via Google public endpoint</div>
  </div>

  <div class="wrap">
    <!-- LEFT: Input -->
    <div class="col" style="max-width:720px">
      <label>###currentAffair (fixed)</label>
      <input id="currentAffair" value="" readonly>

      <div style="display:flex;gap:8px">
        <div style="flex:1">
          <label>###categories</label>
          <input id="categories" placeholder="politics, economy...">
        </div>
        <div style="width:160px">
          <label>###states</label>
          <input id="states" placeholder="INTERNATIONAL / Rajasthan">
        </div>
        <div style="width:110px">
          <label>###lang</label>
          <select id="lang"><option value="hi">hi</option><option value="en">en</option></select>
        </div>
      </div>

      <label>###title (Hindi)</label>
      <input id="title" placeholder="हिंदी में शीर्षक">

      <label>###banner (optional)</label>
      <input type="file" id="bannerInput" accept="image/*">
      <img id="bannerPreview" class="img-preview" style="display:none">

      <label>###body (Hindi)</label>
      <textarea id="body" placeholder="लेख यहाँ लिखो..."></textarea>

      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="addBtn" class="btn btn-green"><i class="fa fa-plus"></i> Add Entry</button>
        <button id="translateAllBtn" class="btn small" style="background:#ff8c00;color:#fff"><i class="fa fa-language"></i> Translate All</button>
        <button id="exportBtn" class="btn btn-blue"><i class="fa fa-file-word"></i> Export DOCX</button>
        <button id="exportJson" class="btn small btn-muted"><i class="fa fa-download"></i> Export JSON</button>
        <button id="importJsonBtn" class="btn small" style="background:#777;color:#fff"><i class="fa fa-upload"></i> Import JSON</button>
        <button id="clearAllBtn" class="btn small" style="background:#999;color:#fff"><i class="fa fa-trash"></i> Clear All</button>
      </div>

      <label style="margin-top:10px">Paste JSON to import</label>
      <textarea id="jsonArea" style="height:90px;font-family:monospace"></textarea>
    </div>

    <!-- RIGHT: Entries list -->
    <div class="col" style="max-width:640px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Entries</strong></div>
        <div class="muted">Click title/body to edit inline · Undo/Redo per entry</div>
      </div>

      <div id="entriesList" style="margin-top:8px"></div>

      <div class="rawBox" id="rawPreview"></div>
    </div>
  </div>
</div>

<script>
/* -------------------- State & Helpers -------------------- */
const STORAGE_KEY = 'ca_final_v1';
let entries = []; // {id,categories,states,lang,titleHi,titleEn,bodyHi,bodyEn,banner:{name,type,dataURL},history:[],redo:[]}
let idCounter = 1;
const $ = id => document.getElementById(id);

function uid(){ return 'e'+(idCounter++); }
function isEmpty(s){ return !s || !String(s).trim(); }
function readFileToDataURL(input){ return new Promise(res=>{ const f = input.files && input.files[0]; if(!f) return res(null); const r=new FileReader(); r.onload=()=>res({name:f.name,type:f.type,dataURL:r.result}); r.readAsDataURL(f); }); }
function xmlEscape(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* load / save */
function load(){
  try{
    const s = localStorage.getItem(STORAGE_KEY);
    if(s){
      const obj = JSON.parse(s);
      entries = obj.entries || [];
      idCounter = obj.idCounter || (entries.length + 1);
      entries.forEach(e=>{ e.history = e.history || []; e.redo = e.redo || []; });
    }
  }catch(e){ console.warn(e); entries = []; }
  renderAll();
}
function save(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({entries,idCounter})); }catch(e){ console.warn(e); }
}

/* -------------------- UI: banner preview and add -------------------- */
let tmpBanner = null;
$('bannerInput').addEventListener('change', async ()=>{
  const d = await readFileToDataURL($('bannerInput'));
  if(d){ tmpBanner = d; $('bannerPreview').src = d.dataURL; $('bannerPreview').style.display='block'; }
});

$('addBtn').addEventListener('click', ()=>{
  const ent = {
    id: uid(),
    categories: $('categories').value.trim(),
    states: $('states').value.trim(),
    lang: $('lang').value || 'hi',
    titleHi: $('title').value.trim(),
    titleEn: '',
    bodyHi: $('body').value.trim(),
    bodyEn: '',
    banner: tmpBanner ? {name:tmpBanner.name,type:tmpBanner.type,dataURL:tmpBanner.dataURL} : null,
    history: [], redo: []
  };
  ent.history.push(JSON.stringify({tHi:ent.titleHi,bHi:ent.bodyHi,tEn:ent.titleEn,bEn:ent.bodyEn,banner:ent.banner}));
  entries.unshift(ent);
  // clear inputs
  $('title').value=''; $('body').value=''; $('bannerInput').value=''; $('bannerPreview').style.display='none'; tmpBanner = null;
  save(); renderAll();
});

/* -------------------- Render entries -------------------- */
function renderAll(){
  const list = $('entriesList'); list.innerHTML = '';
  for(const e of entries){
    const card = document.createElement('div'); card.className='card'; card.dataset.id = e.id;
    const header = document.createElement('div'); header.className='card-header';
    const left = document.createElement('div');
    const t = document.createElement('div'); t.className='card-title'; t.textContent = e.titleHi || '(no title)';
    const meta = document.createElement('div'); meta.className='card-meta'; meta.textContent = `${e.categories || ''}${e.states? ' | '+e.states : ''}`;
    left.appendChild(t); left.appendChild(meta);
    const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';

    right.appendChild(iconBtn('fa-pen','Edit', ()=> startInlineEdit(e.id)));
    right.appendChild(iconBtn('fa-language','Translate', async ()=> { await translateEntry(e.id); }));
    right.appendChild(iconBtn('fa-rotate-left','Undo', ()=> undoEntry(e.id)));
    right.appendChild(iconBtn('fa-rotate-right','Redo', ()=> redoEntry(e.id)));
    right.appendChild(iconBtn('fa-trash','Delete', ()=> { if(confirm('Delete entry?')){ entries = entries.filter(x=>x.id!==e.id); save(); renderAll(); } }));

    header.appendChild(left); header.appendChild(right); card.appendChild(header);

    const body = document.createElement('div'); body.style.marginTop='8px';
    if(e.banner && e.banner.dataURL){
      const im = document.createElement('img'); im.src = e.banner.dataURL; im.className='img-preview'; body.appendChild(im);
    }

    const titleHi = document.createElement('div'); titleHi.contentEditable=true; titleHi.style.fontWeight='700'; titleHi.style.marginTop='8px'; titleHi.textContent = e.titleHi || '';
    titleHi.addEventListener('input', ()=> { e.titleHi = titleHi.textContent; pushHistory(e); save(); });
    body.appendChild(titleHi);

    const bodyHi = document.createElement('div'); bodyHi.contentEditable=true; bodyHi.className='preview-body'; bodyHi.style.minHeight='60px'; bodyHi.textContent = e.bodyHi || '';
    bodyHi.addEventListener('input', ()=> { e.bodyHi = bodyHi.textContent; pushHistory(e); save(); });
    body.appendChild(bodyHi);

    // english editable
    const titleEn = document.createElement('div'); titleEn.contentEditable=true; titleEn.style.fontWeight='700'; titleEn.style.marginTop='10px'; titleEn.textContent = e.titleEn || ''; titleEn.addEventListener('input', ()=> { e.titleEn = titleEn.textContent; pushHistory(e); save(); });
    body.appendChild(titleEn);
    const bodyEn = document.createElement('div'); bodyEn.contentEditable=true; bodyEn.className='preview-body'; bodyEn.textContent = e.bodyEn || ''; bodyEn.addEventListener('input', ()=> { e.bodyEn = bodyEn.textContent; pushHistory(e); save(); });
    body.appendChild(bodyEn);

    card.appendChild(body);
    list.appendChild(card);
  }
}

/* icon helper */
function iconBtn(cls,title,fn){
  const b = document.createElement('button'); b.className='icon-btn'; b.title = title; b.innerHTML = `<i class="fa ${cls}"></i>`;
  b.addEventListener('click',(ev)=>{ ev.stopPropagation(); fn(); });
  return b;
}

/* -------------------- History undo/redo -------------------- */
function pushHistory(e){
  e.history = e.history || []; e.redo = e.redo || [];
  const snap = JSON.stringify({tHi:e.titleHi,bHi:e.bodyHi,tEn:e.titleEn,bEn:e.bodyEn,banner:e.banner});
  if(e.history[e.history.length-1] !== snap){ e.history.push(snap); if(e.history.length>60) e.history.shift(); e.redo = []; }
}
function undoEntry(id){
  const e = entries.find(x=>x.id===id); if(!e || !e.history || e.history.length<=1) return alert('No undo available');
  const cur = e.history.pop(); e.redo.push(cur);
  const prev = e.history[e.history.length-1]; const obj = JSON.parse(prev);
  e.titleHi = obj.tHi; e.bodyHi = obj.bHi; e.titleEn = obj.tEn; e.bodyEn = obj.bEn; e.banner = obj.banner;
  save(); renderAll();
}
function redoEntry(id){
  const e = entries.find(x=>x.id===id); if(!e || !e.redo || e.redo.length===0) return alert('No redo');
  const snap = e.redo.pop(); e.history.push(snap); const obj = JSON.parse(snap);
  e.titleHi = obj.tHi; e.bodyHi = obj.bHi; e.titleEn = obj.tEn; e.bodyEn = obj.bEn; e.banner = obj.banner;
  save(); renderAll();
}

/* start inline edit */
function startInlineEdit(id){
  const card = document.querySelector(`.card[data-id="${id}"]`);
  if(card){ const ce = card.querySelector('[contenteditable="true"]'); if(ce){ ce.focus(); placeCaretAtEnd(ce); } }
}
function placeCaretAtEnd(el){ el.focus(); if(window.getSelection && document.createRange){ const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); } }

/* -------------------- Translate APIs -------------------- */
async function translateApi(text, sl='hi', tl='en'){
  if(!text) return '';
  try{
    const q = encodeURIComponent(text);
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${q}`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Translate failed: ' + res.status);
    const data = await res.json();
    const segs = data[0].map(s => s[0]).filter(Boolean);
    return segs.join('');
  }catch(e){ console.warn(e); return ''; }
}

async function translateEntry(id){
  const e = entries.find(x=>x.id===id); if(!e) return;
  if(e.titleHi) e.titleEn = await translateApi(e.titleHi,'hi','en');
  if(e.bodyHi) e.bodyEn = await translateApi(e.bodyHi,'hi','en');
  pushHistory(e); save(); renderAll();
}

$('translateAllBtn').addEventListener('click', async ()=>{
  for(const e of entries){
    if(e.titleHi) e.titleEn = await translateApi(e.titleHi,'hi','en');
    if(e.bodyHi) e.bodyEn = await translateApi(e.bodyHi,'hi','en');
    pushHistory(e);
  }
  save(); renderAll(); alert('Translated all (HI→EN)');
});

/* -------------------- Import / Export JSON -------------------- */
$('importJsonBtn').addEventListener('click', ()=>{
  const v = $('jsonArea').value.trim(); if(!v) return alert('Paste JSON');
  try{
    const parsed = JSON.parse(v);
    const arr = Array.isArray(parsed)? parsed : [parsed];
    arr.forEach(o=>{
      const ent = {
        id: uid(),
        categories: o.categories||'',
        states: o.states||'',
        lang: o.lang||'hi',
        titleHi: o.title || o.titleHi || '',
        titleEn: o.titleEn || '',
        bodyHi: o.body || o.bodyHi || '',
        bodyEn: o.bodyEn || '',
        banner: o.banner || null,
        history: [], redo: []
      };
      ent.history.push(JSON.stringify({tHi:ent.titleHi,bHi:ent.bodyHi,tEn:ent.titleEn,bEn:ent.bodyEn,banner:ent.banner}));
      entries.unshift(ent);
    });
    save(); renderAll(); alert('Imported ' + arr.length + ' entries');
  }catch(e){ alert('Invalid JSON'); console.error(e); }
});

$('exportJson').addEventListener('click', ()=> {
  const out = entries.map(e=>({
    categories:e.categories, states:e.states, lang:e.lang,
    titleHi:e.titleHi, titleEn:e.titleEn, bodyHi:e.bodyHi, bodyEn:e.bodyEn, banner:e.banner
  }));
  const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='current_affairs.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),3000);
});

/* clear all */
$('clearAllBtn').addEventListener('click', ()=> { if(!confirm('Clear all entries?')) return; entries=[]; save(); renderAll(); });

/* autosave */
setInterval(save,2000);

/* -------------------- DOCX builder (no separators, banner blank line, images embed) -------------------- */

/* drawing xml for image rId */
function makeDrawingXml(rId, cx=4500000, cy=3000000){
  return `<w:p><w:r><w:drawing><wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"><wp:extent cx="${cx}" cy="${cy}"/><wp:docPr id="1" name="Image"/><a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"><a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture"><pic:nvPicPr><pic:cNvPr id="0" name="Image"/><pic:cNvPicPr/></pic:nvPicPr><pic:blipFill><a:blip xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" r:embed="${rId}"/><a:stretch><a:fillRect/></a:stretch></pic:blipFill><pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="${cx}" cy="${cy}"/></a:xfrm><a:prstGeom prst="rect"><a:avLst/></a:prstGeom></pic:spPr></pic:pic></a:graphicData></a:graphic></wp:inline></w:drawing></w:r></w:p>`;
}

/* Build document.xml with hi then en for each entry; no extra separators; banner followed by a blank paragraph then image */
function buildDocumentXml(relMapPerEntry){
  let body = '';
  for(let i=0;i<entries.length;i++){
    const e = entries[i];
    const rmap = relMapPerEntry[i] || {};
    // HI block
    body += `<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape($('currentAffair').value)}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###categories</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.categories||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###states</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.states||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###lang</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>hi</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###title</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.titleHi||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###banner</w:t></w:r></w:p>`;
    // blank line after banner tag
    body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    if(rmap.banner) body += makeDrawingXml(rmap.banner, 4500000, 3000000);
    else body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###body</w:t></w:r></w:p>`;
    (e.bodyHi||'').split(/\n+/).forEach(p => { body += `<w:p><w:r><w:t>${xmlEscape(p)}</w:t></w:r></w:p>`; });

    // EN block
    body += `<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape($('currentAffair').value)}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###categories</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.categories||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###states</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.states||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###lang</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>en</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###title</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>${xmlEscape(e.titleEn||'')}</w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###banner</w:t></w:r></w:p>`;
    // blank line after banner tag (EN)
    body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    if(rmap.banner) body += makeDrawingXml(rmap.banner, 4500000, 3000000);
    else body += `<w:p><w:r><w:t></w:t></w:r></w:p>`;
    body += `<w:p><w:r><w:t>###body</w:t></w:r></w:p>`;
    (e.bodyEn||'').split(/\n+/).forEach(p => { body += `<w:p><w:r><w:t>${xmlEscape(p)}</w:t></w:r></w:p>`; });
  }

  const documentXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
            xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
            xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
            xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
            xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
  <w:body>
    ${body}
    <w:p/><w:sectPr/>
  </w:body>
</w:document>`;
  return documentXml;
}

/* Build package files and media mapping */
function buildPackageFiles(){
  const mediaFiles = [];
  entries.forEach((e, idx)=>{
    if(e.banner && e.banner.dataURL){
      const d = e.banner;
      const comma = d.dataURL.indexOf(',');
      const b64 = d.dataURL.slice(comma+1);
      const binStr = atob(b64);
      const u8 = new Uint8Array(binStr.length);
      for(let i=0;i<binStr.length;i++) u8[i] = binStr.charCodeAt(i);
      let ext='png';
      if(d.type && d.type.indexOf('jpeg')!==-1) ext='jpg';
      const name = `image${mediaFiles.length+1}.${ext}`;
      mediaFiles.push({name,type:d.type||('image/'+ext),data:u8,entryIndex:idx});
    }
  });

  const relMapPerEntry = entries.map(()=>({banner:null}));
  mediaFiles.forEach((m,i)=>{ relMapPerEntry[m.entryIndex].banner = 'rIdImg'+(i+1); });

  const documentXml = buildDocumentXml(relMapPerEntry);

  let relsXml = `<?xml version="1.0" encoding="UTF-8"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">`;
  mediaFiles.forEach((m,i)=> relsXml += `\n  <Relationship Id="rIdImg${i+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/${m.name}"/>`);
  relsXml += `\n</Relationships>`;

  const extMap = {};
  mediaFiles.forEach(m => { const ext = m.name.split('.').pop(); extMap[ext] = m.type; });

  let ctXml = `<?xml version="1.0" encoding="UTF-8"?>\n<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">\n`;
  ctXml += `  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>\n`;
  ctXml += `  <Default Extension="xml" ContentType="application/xml"/>\n`;
  Object.keys(extMap).forEach(ext => { ctXml += `  <Default Extension="${ext}" ContentType="${extMap[ext]}"/>\n`; });
  ctXml += `  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>\n</Types>`;

  const files = {};
  files["[Content_Types].xml"] = ctXml;
  files["_rels/.rels"] = `<?xml version="1.0"?>\n<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">\n  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>\n</Relationships>`;
  files["word/document.xml"] = documentXml;
  files["word/_rels/document.xml.rels"] = relsXml;
  mediaFiles.forEach(m => files[`word/media/${m.name}`] = m.data);
  return files;
}

/* ZIP builder (binary-safe, stable) */
function buildZip(files){
  const encoder = new TextEncoder();
  function toUint8(x){ if(typeof x === 'string') return encoder.encode(x); if(x instanceof Uint8Array) return x; if(x instanceof ArrayBuffer) return new Uint8Array(x); throw new Error('Unsupported file data'); }
  function uint32LE(n){ return [n & 0xff,(n>>8)&0xff,(n>>16)&0xff,(n>>24)&0xff]; }
  const crcTable = (function(){ let c; const table = new Uint32Array(256); for(let n=0;n<256;n++){ c=n; for(let k=0;k<8;k++){ c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);} table[n]=c>>>0;} return table; })();
  function crc32(buf){ let crc = 0 ^ (-1); for(let i=0;i<buf.length;i++) crc = (crc>>>8) ^ crcTable[(crc ^ buf[i]) & 0xff]; return (crc ^ (-1)) >>> 0; }

  const localParts = [], centralParts = [];
  let offset = 0;
  for(const name in files){
    const data = toUint8(files[name]);
    const fname = encoder.encode(name);
    const crc = crc32(data);
    const compSize = data.length, uncompSize = data.length;

    const lh = new Uint8Array(30 + fname.length);
    lh.set([0x50,0x4b,0x03,0x04],0);
    lh.set([20,0],4);
    lh.set([0,0],6);
    lh.set([0,0],8);
    lh.set([0,0,0,0],10);
    lh.set(uint32LE(crc),14);
    lh.set(uint32LE(compSize),18);
    lh.set(uint32LE(uncompSize),22);
    lh.set([fname.length & 0xff, (fname.length>>8)&0xff],26);
    lh.set(fname,30);
    localParts.push({lh,data});
    offset += lh.length + data.length;

    const ch = new Uint8Array(46 + fname.length);
    ch.set([0x50,0x4b,0x01,0x02],0);
    ch.set([20,0],4); ch.set([20,0],6);
    ch.set([0,0],8); ch.set([0,0],10);
    ch.set([0,0,0,0],12);
    ch.set(uint32LE(crc),16);
    ch.set(uint32LE(compSize),20);
    ch.set(uint32LE(uncompSize),24);
    ch.set([fname.length & 0xff, (fname.length>>8)&0xff],28);
    ch.set([0,0,0,0],30); ch.set([0,0,0,0],32);
    ch.set([0,0],36); ch.set([0,0,0,0],38);
    const localStart = offset - (lh.length + data.length);
    ch.set(uint32LE(localStart),42);
    ch.set(fname,46);
    centralParts.push(ch);
  }

  let totalLocal = 0; localParts.forEach(it => totalLocal += it.lh.length + it.data.length);
  let centralSize = 0; centralParts.forEach(c => centralSize += c.length);
  const eocdSize = 22;
  const out = new Uint8Array(totalLocal + centralSize + eocdSize);
  let p = 0;
  localParts.forEach(it => { out.set(it.lh, p); p += it.lh.length; out.set(it.data, p); p += it.data.length; });
  const cdStart = p;
  centralParts.forEach(c => { out.set(c, p); p += c.length; });
  const cdSize = p - cdStart;
  out.set([0x50,0x4b,0x05,0x06], p); p += 4;
  out.set([0,0], p); p += 2;
  out.set([0,0], p); p += 2;
  const entriesCount = centralParts.length;
  out.set([ entriesCount & 0xff, (entriesCount>>8)&0xff ], p); p += 2;
  out.set([ entriesCount & 0xff, (entriesCount>>8)&0xff ], p); p += 2;
  out.set(uint32LE(cdSize), p); p += 4;
  out.set(uint32LE(cdStart), p); p += 4;
  out.set([0,0], p); p += 2;
  return new Blob([out], {type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
}

/* export docx */
$('exportBtn').addEventListener('click', ()=> {
  if(entries.length===0){ if(!confirm('No entries — export empty doc?')) return; }
  try{
    const files = buildPackageFiles();
    const blob = buildZip(files);
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'current_affairs.docx'; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 5000);
  }catch(e){
    console.error(e); alert('Export failed: ' + (e && e.message));
  }
});

/* -------------------- Init -------------------- */
load();
renderAll();

</script>
</body>
</html>
