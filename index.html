<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Current Affairs Clean DOCX Export</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{
  font-family:Arial;
  margin:20px;
  background:#f7f7f7;
}
.container{
  max-width:750px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:10px;
  border:1px solid #ddd;
}
label{font-weight:bold;margin-top:10px;display:block}
input,textarea{
  width:100%;
  padding:8px;
  margin-top:5px;
  border:1px solid #ccc;
  border-radius:6px;
}
button{
  padding:10px 14px;
  border:0;
  border-radius:6px;
  background:#333;
  color:white;
  cursor:pointer;
  margin-top:10px;
}
.icon-btn{
  background:transparent;
  border:0;
  font-size:18px;
  cursor:pointer;
  color:#000;       /* <-- icons are BLACK now */
}
.preview img{
  max-width:300px;
  border:1px solid #ccc;
  margin-top:10px;
  border-radius:6px;
}
.entry-card{
  border:1px solid #ccc;
  padding:10px;
  margin-top:10px;
  border-radius:8px;
  background:#fafafa;
}
</style>
</head>

<body>
<div class="container">

<h2>Current Affairs â†’ Clean DOCX Export</h2>

<label>###categories</label>
<input id="categories">

<label>###states</label>
<input id="states">

<label>###lang (always hi)</label>
<input id="lang" value="hi">

<label>###title (Hindi)</label>
<input id="title">

<label>###banner (Optional)</label>
<input type="file" id="bannerInput" accept="image/*">

<div id="bannerPreview"></div>

<label>###body (Hindi)</label>
<textarea id="body" rows="6"></textarea>

<button onclick="addEntry()">Add Entry</button>
<button onclick="exportDocx()">Export DOCX</button>

<h3>Entries</h3>
<div id="entries"></div>

</div>

<script>
let entries = [];

/* read image */
function readFileData(input){
  return new Promise(res=>{
    if(!input.files || !input.files[0]) return res(null);
    const f=input.files[0];
    const r=new FileReader();
    r.onload=()=>res({name:f.name,type:f.type,dataURL:r.result});
    r.readAsDataURL(f);
  });
}

/* Add entry */
async function addEntry(){
  const cat=document.getElementById("categories").value.trim();
  const st=document.getElementById("states").value.trim();
  const lang=document.getElementById("lang").value.trim();
  const title=document.getElementById("title").value.trim();
  const body=document.getElementById("body").value.trim();
  const banner=await readFileData(document.getElementById("bannerInput"));

  const item={cat,st,lang,title,body,banner};
  entries.push(item);
  renderEntries();

  document.getElementById("bannerInput").value="";
  document.getElementById("bannerPreview").innerHTML="";
  document.getElementById("title").value="";
  document.getElementById("body").value="";
}

function renderEntries(){
  const box=document.getElementById("entries");
  box.innerHTML="";

  entries.forEach((e,i)=>{
    const card=document.createElement("div");
    card.className="entry-card";

    card.innerHTML+=`<b>${e.title}</b><br><small>${e.cat} | ${e.st}</small>`;

    if(e.banner){
      const im=document.createElement("img");
      im.src=e.banner.dataURL;
      im.style.maxWidth="150px";
      card.appendChild(im);
    }

    card.innerHTML+=`
      <div>
        <button class="icon-btn" onclick="deleteEntry(${i})"><i class="fa fa-trash"></i></button>
      </div>
    `;

    box.appendChild(card);
  });
}

function deleteEntry(i){
  entries.splice(i,1);
  renderEntries();
}

/* ---------- DOCX Builder ---------- */

/* xml escape */
function x(s){
  return String(s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

/* drawing xml */
function makeDrawing(rId){
return `
<w:p><w:r><w:t></w:t></w:r></w:p>
<w:p><w:r><w:drawing>
<wp:inline xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing">
<wp:extent cx="4500000" cy="3000000"/>
<wp:docPr id="1" name="Banner"/>
<a:graphic xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">
<a:graphicData uri="http://schemas.openxmlformats.org/drawingml/2006/picture">
<pic:pic xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
<pic:nvPicPr><pic:cNvPr id="0" name="img"/><pic:cNvPicPr/></pic:nvPicPr>
<pic:blipFill>
<a:blip xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" r:embed="${rId}"/>
<a:stretch><a:fillRect/></a:stretch>
</pic:blipFill>
<pic:spPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="4500000" cy="3000000"/></a:xfrm>
<a:prstGeom prst="rect"><a:avLst/></a:prstGeom></pic:spPr>
</pic:pic>
</a:graphicData>
</a:graphic>
</wp:inline>
</w:drawing></w:r></w:p>`;
}

/* build full document.xml */
function buildDocXML(rmap){
  let xml="";

  entries.forEach((e,i)=>{

    xml+=`<w:p><w:r><w:t>###currentAffair</w:t></w:r></w:p>
<w:p><w:r><w:t>currentAffair</w:t></w:r></w:p>

<w:p><w:r><w:t>###categories</w:t></w:r></w:p>
<w:p><w:r><w:t>${x(e.cat)}</w:t></w:r></w:p>

<w:p><w:r><w:t>###states</w:t></w:r></w:p>
<w:p><w:r><w:t>${x(e.st)}</w:t></w:r></w:p>

<w:p><w:r><w:t>###lang</w:t></w:r></w:p>
<w:p><w:r><w:t>${x(e.lang)}</w:t></w:r></w:p>

<w:p><w:r><w:t>###title</w:t></w:r></w:p>
<w:p><w:r><w:t>${x(e.title)}</w:t></w:r></w:p>

<w:p><w:r><w:t>###banner</w:t></w:r></w:p>
<w:p><w:r><w:t></w:t></w:r></w:p>
`;

    if(rmap[i]) xml+=makeDrawing(rmap[i]);

    xml+=`
<w:p><w:r><w:t>###body</w:t></w:r></w:p>
<w:p><w:r><w:t>${x(e.body)}</w:t></w:r></w:p>
`;
  });

  return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
xmlns:pic="http://schemas.openxmlformats.org/drawingml/2006/picture">
<w:body>${xml}<w:sectPr/></w:body>
</w:document>`;
}

/* ZIP builder (stable) */
function buildZip(files){
  const enc=new TextEncoder();

  function toBytes(v){
    if(v instanceof Uint8Array) return v;
    return enc.encode(v);
  }

  function u32(n){
    return [n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255];
  }

  function crc32(buf){
    let c=~0;
    for(let i=0;i<buf.length;i++){
      c=(c>>>8)^table[(c^buf[i])&255];
    }
    return ~c>>>0;
  }

  if(!window.__zip_crc){
    const t=new Uint32Array(256);
    for(let i=0;i<256;i++){
      let c=i;
      for(let k=0;k<8;k++) c=(c&1)?(0xEDB88320^(c>>>1)):(c>>>1);
      t[i]=c>>>0;
    }
    window.__zip_crc=t;
  }
  const table=window.__zip_crc;

  let local=[],central=[];
  let offset=0;

  for(const name in files){
    const data=toBytes(files[name]);
    const fname=enc.encode(name);
    const crc=crc32(data);

    const lh=new Uint8Array(30+fname.length);
    lh.set([0x50,0x4B,0x03,0x04],0);
    lh[4]=20;
    lh[26]=fname.length;
    lh[27]=0;
    lh.set(u32(crc),14);
    lh.set(u32(data.length),18);
    lh.set(u32(data.length),22);
    lh.set(fname,30);

    local.push(lh,data);

    const ch=new Uint8Array(46+fname.length);
    ch.set([0x50,0x4B,0x01,0x02],0);
    ch[4]=20;
    ch[6]=20;
    ch[28]=fname.length;
    ch.set(u32(crc),16);
    ch.set(u32(data.length),20);
    ch.set(u32(data.length),24);
    ch.set(u32(offset),42);
    ch.set(fname,46);

    central.push(ch);

    offset+=lh.length+data.length;
  }

  const csize=central.reduce((s,c)=>s+c.length,0);
  const end=new Uint8Array(22);
  end.set([0x50,0x4B,0x05,0x06],0);
  const count=central.length;
  end[8]=count; end[10]=count;
  end.set(u32(csize),12);
  end.set(u32(offset),16);

  const total=new Uint8Array(offset+csize+22);
  let p=0;

  local.forEach(part=>{ total.set(part,p); p+=part.length; });
  central.forEach(c=>{ total.set(c,p); p+=c.length; });
  total.set(end,p);

  return new Blob([total],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
}

async function exportDocx(){
  if(entries.length===0) return alert("No entries.");

  const media=[];
  const rmap={};

  entries.forEach((e,i)=>{
    if(e.banner){
      const d=e.banner;
      const b64=d.dataURL.split(",")[1];
      const bin=atob(b64);
      const u8=new Uint8Array(bin.length);
      for(let k=0;k<bin.length;k++) u8[k]=bin.charCodeAt(k);
      const name="banner"+(i+1)+".png";
      media.push({name,data:u8,index:i});
      rmap[i]="rId"+(i+1);
    }
  });

  const docXML=buildDocXML(rmap);

  let rels="";
  media.forEach((m,i)=>{
    rels+=`<Relationship Id="rId${i+1}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/image" Target="media/${m.name}"/>`;
  });

  const files={};

  files["[Content_Types].xml"]=
`<?xml version="1.0" encoding="UTF-8"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="xml" ContentType="application/xml"/>
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="png" ContentType="image/png"/>
<Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
</Types>`;

  files["_rels/.rels"]=
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  files["word/_rels/document.xml.rels"]=
`<?xml version="1.0" encoding="UTF-8"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
${rels}
</Relationships>`;

  files["word/document.xml"]=docXML;

  media.forEach(m=>{
    files[`word/media/${m.name}`]=m.data;
  });

  const blob=buildZip(files);
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="current_affairs.docx"; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),3000);
}

</script>
</body>
</html>
